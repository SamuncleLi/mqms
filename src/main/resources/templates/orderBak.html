<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/themes/icon.css">
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/jquery.min.js"></script>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/locale/easyui-lang-zh_CN.js"></script>
    <style type="text/css">
        html { overflow-y:hidden; }
        td{
            padding: 5px;
        }
        .easyui-textbox{
            width: 135px;
        }
        .easyui-combobox{
            width: 135px;
        }
        .easyui-datebox{
            width: 135px;
        }
    </style>
    <script type="text/javascript">
        var formUrl = "/wms/order/build";
        $(function () {
            $("#dg").datagrid({
                url:"/wms/order/list",
                method:"GET",
            })
            $('.special_tr').hide();

            //选择框选项配置
            $(".easyui-combobox.dict").each(function (index, element) {
                console.log(element);
                $("#"+element.id).combobox({url:"/wms/dict/listInArray?dictType1="+$("#"+element.id).attr("comboname")});
            })
            //物料查询
            $('#materialCode').textbox('textbox').keydown(function (e) {
                if (e.keyCode == 13) {
                    searchMaterial();
                }
            })
            //根据管理类型来切换定制项目,form里的url也随之变化
            $("#managementType").combobox({
                onSelect:function (record) {
                    $('.special_tr').hide();
                    //拼接class，combobox里的value就是对应的特殊行的class
                    console.log(record);
                    $("." + record.dictValue + "_tr").show();
                }
            })
        })
        function add() {
            $('#dlg').dialog("open", "新增订单")
        }
        function saveDlg() {
            $("#fm").form("submit", {
                url: formUrl,
                dataType: "json",
                onSubmit: function () {
                    //验证订单，订单必须填物料号、数量。物料号如果不存在，则必须填写所有信息
                    return true
                },
                success: function (result) {
                    console.log(result);
                    var result = JSON.parse(result);
                    if (result.success != "true") {
                        $.messager.alert('系统提示', "<font color=red>" + result.errorMsg + "</font>");
                        return;
                    } else {
                        $.messager.alert('系统提示', '保存成功');
                        $("#dg").datagrid("reload");
                        $("#dlg").dialog("close");
                        $("#fm").form("clear");
                    }
                }
            })
        }
        function closeDlg() {
            $('#dlg').dialog('close');
        }
        function excelFileUpload() {
            //首先验证文件格式
            var fileName = $('#excelFile').val();
            if (fileName === '') {
                alert('请选择文件');
                return false;
            }
            var fileType = (fileName.substring(fileName
                            .lastIndexOf(".") + 1, fileName.length))
                    .toLowerCase();
            if (fileType !== 'xls' && fileType !== 'xlxs') {
                alert('文件格式不正确，请上传bpmn文件！');
                return false;
            }
            alert('系统提示',"正在上传，上传完成后会有提示，请耐心等候");
            $("#excelForm").ajaxSubmit({
                url:"/",
                dataType:"json",
                success:function(data) {
                    if (data.success == 'true') {
                        $.messager.alert("系统提示",'上传文件成功');
                    } else {
                        $.messager.alert("系统提示",'上传文件失败');
                    }
                    return false;
                }
            });
            return false;
        }
        function closeExcelDlg() {
            $('#excelDlg').dialog('close');
        }
        function openUploadDlg(){
            $('#excelDlg').dialog('open','上传excel');
        }

        function searchMaterial(){
            $.getJSON("/wms/material/listLimit1",{materialCode:$('#materialCode').textbox('getText')},function (result) {
                console.log(result);
                $('#materialName').textbox('setValue',result.materialName);
                $('#materialSpecs').textbox('setValue',result.materialSpecs);
                $('#supplierCode').textbox('setValue',result.supplierCode);
                $('#warehouseCode').textbox('setValue',result.warehouseCode);

                if(result.contractType == "已签开口合同"){
                    $(".contract_tr").show();
                    $(".no_contract_tr").hide()
                }
                if(result.contractType == "未签开口合同"){
                    $(".contract_tr").show();
                    $(".no_contract_tr").hide()
                }
                if(result.materialName == undefined){
                    $.messager.confirm({
                        title:"系统提示",
                        msg:"物料不存在，是否是新增物料",
                        ok:"是",
                        cancel:"否",
                        fn:function (r) {
                            if (r){
                                //如果是新物料，则勾选新物料选项
                            }
                            else{
                                //如果用户确认不是新物料，则清空
                            }
                        }
                    });
                }
            })
        }

        function search(){
            var url= "/wms/order/list";
//            $("#searchForm").form("submit", {
//                url: url,
//                dataType: "json",
//                onSubmit: function () {
//                    return true
//                },
//                success: function (result) {
//                    var result = JSON.parse(result);
//                    $('#dg').datagrid('loadData', result);
//                }
//            })
            console.log($("#searchForm").serialize());
            $('#dg').datagrid({
                url:url+"?"+$("#searchForm").serialize(),

            })
//            $('#dg').datagrid('reload', $("#searchForm").serialize());
        }

        function downloadOrderContract() {
            document.getElementById("searchForm").action = "/wms/order/download/contract";
            document.getElementById("searchForm").submit();
        }
        function downloadOrderNoContract() {
            document.getElementById("searchForm").action = "/wms/order/download/noContract";
            document.getElementById("searchForm").submit();
        }
    </script>
<body style="overflow-y: hidden">
<div id="tb">
    <div>
        <a href="javascript:add()" class="easyui-linkbutton" iconCls="icon-add" >新增</a>
        <a href="javascript:saveProcessChecker()" class="easyui-linkbutton" iconCls="icon-edit" >修改</a>
        <a href="javascript:saveProcessChecker()" class="easyui-linkbutton" iconCls="icon-remove" >删除</a>
        <a href="javascript:openUploadDlg()" class="easyui-linkbutton">导入excel</a>
    </div>
    <div>
        <form id="searchForm">
        <table>
            <tr>
                <td>采购订单号:</td><td><input id="purchasingOrderCodeSearch" name="purchasingOrderCode" class="easyui-textbox"></td>
                <td>采购担当</td><td><input id="supplierNameSearch" name="supplierName" class="easyui-textbox"></td>
                <td>申请日期:</td><td><input id="orderOperaterTimeSearch" name="orderOperaterTime" class="easyui-datebox"></td>
            </tr>
            <tr>
                <td>物料号:</td><td><input id="materialCodeSearch" name="materialCode" class="easyui-textbox"></td>
                <td>物料名称:</td><td><input id="materialNameSearch" name="materialName" class="easyui-textbox"></td>
                <td>规格:</td><td><input id="materialSpecsSearch" name="materialSpecs" class="easyui-textbox"></td>
                <td ><a href="javascript:search()" class="easyui-linkbutton" iconCls="icon-search" >搜索</a></td>
            </tr>
            <tr>
                <a href="javascript:downloadOrderContract()" class="easyui-linkbutton">导出已签开口合同excel</a>
                <a href="javascript:downloadOrderNoContract()" class="easyui-linkbutton">导出未签开口合同excel</a>
            </tr>
        </table>
        </form>
    </div>
</div>

<table id="dg" title="订单信息" class="easyui-datagrid" fitColumns="false"
       pagination="true" rownumbers="true" fit="true" toolbar="#tb" method="GET"
       pageList="[ 10, 50, 100, 500, 2000]">
    <thead frozen="true">
    <tr>
        <th field="cb" checkbox="true" align="center"></th>
        <th field="purchasingOrderCode" align="center">采购订单编号</th>
    </tr>
    </thead>
    <thead>
    <tr>
        <th field="orderInitialUserName" align="center">申请人</th>
        <th field="orderInitialTime" align="center">WMS提单时间</th>
        <th field="orderInitialState" align="center">WMS审核状态</th>
        <th field="productionLine" align="center">生产线</th>
        <th field="materialCode" align="center">物料号</th>
        <th field="materialName" align="center">物料名称</th>
        <th field="materialSpecs" align="center">规格型号</th>
        <th field="orderMaterialNum" align="center">订购日期数量</th>
        <th field="productionLine" align="center">生产线</th>
        <th field="operationPosition" align="center">工序号</th>
        <th field="extraOrderReson" align="center">订购原因</th>
        <th field="orderOperaterTime" align="center">申请日期</th>
        <th field="orderType" align="center">类别</th>
        <th field="financialListCode" align="center">财务审批表</th>
        <th field="purchasingListCode" align="center">采购申请单号</th>
        <th field="materialCode" align="center">物料编码</th>
        <th field="orderMaterialName" align="center">申请名称</th>
        <th field="confirmMaterialName" align="center">确定名称</th>
        <th field="orderMaterialSpecs" align="center">申请规格型号</th>
        <th field="confirmMaterialSpecs" align="center">确定规格型号</th>
        <th field="orderMaterialBrand" align="center">申请品牌</th>
        <th field="confirmMaterialBrand" align="center">确定品牌</th>
        <th field="financialCenterCode" align="center">费用中心</th>
        <th field="orderBuyer" align="center">采购担当</th>
        <th field="orderState" align="center">当前状态</th>
        <th field="orderBuyerCheckDate" align="center">采购审核日期</th>
        <th field="orderPriceCheckDate" align="center">价格审核日期</th>
        <th field="purchasingOrderCode" align="center">采购订单号</th>
        <th field="arrivalDate" align="center">到货日期</th>
        <th field="receivedNum" align="center">验收数量</th>
        <th field="receivedDate" align="center">验收日期</th>
        <th field="paymentType" align="center">付款方式</th>
        <th field="paymentRate" align="center">付款比率</th>
        <th field="budgetType" align="center">预算类别</th>
        <th field="budgetSubject" align="center">预算科目</th>
        <th field="investManagementCode" align="center">投资管理号</th>
        <th field="researchTestProject" align="center">研试费项目</th>
        <th field="orderBuilderName" align="center">建单人</th>
        <th field="orderDescription" align="center">备注</th>
        <th field="orderId" align="center" hidden="hidden"></th>
    </tr>
    </thead>
</table>

<div id="dlg" name="dlg" class="easyui-dialog" title="新增订单" style="width: 800px;height: 600px" closed="true" buttons="#dlgbutton">
    <form id="fm" method="post">
        <table id="easyui-datagrid"
               data-options="
               toolbar: '#dlgtb',
               onClickCell: onClickCell,
                onEndEdit: onEndEdit
            ">
            <tr>
                <td>管理类型</td><td><input class="easyui-combobox dict" id="managementType" name="managementType" valueField="dictValue" textField="dictText"></td>
            </tr>
            <tr>
                <td>物料编号</td><td><input class="easyui-textbox" id="materialCode" name="materialCode" required="required"></td>
                <td>物料名称</td><td><input class="easyui-textbox" id="materialName" name="materialName"></td>
                <td>规格</td><td><input class="easyui-textbox" id="materialSpecs" name="materialSpecs"></td>
            </tr>
            <tr>
                <td>供应商编号</td><td><input class="easyui-textbox" id="supplierCode" name="supplierCode"></td>
                <td>仓库编码</td><td><input class="easyui-combobox dict" id="warehouseCode" name="warehouseCode" valueField="dictValue" textField="dictText"></td>
            </tr>
            <tr class="contract_tr">
                <td>在库区分</td><td><input class="easyui-combobox dict" id="warehouseSymbol" name="warehouseSymbol" valueField="dictValue" textField="dictText"></td>
                <td>订购数量</td><td><input class="easyui-textbox" id="orderMaterialNum" name="orderMaterialNum"></td>
                <td>费用中心</td><td><input class="easyui-combobox dict" id="financialCenterCode" name="financialCenterCode" valueField="dictValue" textField="dictText"></td>
            </tr>
            <tr class="contract_tr">
                <td>出库原因代码</td><td><input class="easyui-combobox dict" id="warehousingReasonCode" name="warehousingReasonCode" valueField="dictValue" textField="dictText"></td>
            </tr>
        </table>


            <tr class="no_contract_tr">
                <td colspan="6">--------------------------------未签开口合同选项-----------------------------------</td>
            </tr>
            <tr class="no_contract_tr">
                <td>计量单位</td><td><input class="easyui-combobox dict" id="materialUnit" name="materialUnit" valueField="dictValue" textField="dictText"></td>
                <td>推荐供应商</td><td><input class="easyui-textbox" id="recommendedSupplierName" name="recommendedSupplierName"></td>
                <td>希望交货日期</td><td><input class="easyui-datebox" id="prospectiveArrivalDate" name="prospectiveArrivalDate"></td>
            </tr>
            <tr class="no_contract_tr">
                <td>重点项目管理号</td><td><input class="easyui-textbox" id="importantProjectCode" name="importantProjectCode"></td>
                <td>研试费项目</td><td><input class="easyui-textbox" id="researchTestProject" name="researchTestProject"></td>
            </tr>
            <tr class="no_contract_tr">
                <td>品牌</td><td colspan="5"><input class="easyui-combobox spare_parts_td" id="extraOrderReason" name="extraOrderReason" style="width: 400px"></td>
            </tr>

            <tr class="special_tr spare_parts_tr">
                <td colspan="6">--------------------------------备件选项-----------------------------------</td>
            </tr>

            <#--<tr class="special_tr goods_tr">-->
                <#--<td colspan="6">--------------------------------资材选项-----------------------------------</td>-->
            <#--</tr>-->
            <#--<tr class="special_tr goods_tr">-->
                <#--<td>资材管理人</td><td><input class="easyui-textbox" id="" name=""></td>-->
            <#--</tr>-->

            <tr class="special_tr spare_parts_tr knife_tr">
                <td colspan="6">--------------------------------刀具选项-----------------------------------</td>
            </tr>

            <tr class="special_tr knife_tr">
                <td>生产线：</td><td><input class="easyui-textbox knife_td" id=productionLine"" name="productionLine"></td>
                <td>工序号</td><td><input class="easyui-textbox knife_td" id="operationPositionCode" name="operationPositionCode"></td>
                <td>刀号</td><td><input class="easyui-textbox knife_td" id="knifeCode" name="knifeCode"></td>
            </tr>
            <tr class="special_tr spare_parts_tr">
                <td>设备厂家</td><td colspan="5"><input class="easyui-combobox spare_parts_td" id="equipmentCompany" name="equipmentCompany"></td>
            </tr>
            <tr class="special_tr spare_parts_tr">
                <td>订购性质</td><td><input class="easyui-combobox spare_parts_td dict" id="sparePartsOrderDesc" name="sparePartsOrderDesc" valueField="dictValue" textField="dictText" editable="false"></td>
                <td>紧急性</td><td><input class="easyui-combobox spare_parts_td dict" id="sparePartsEmergency" name="sparePartsEmergency" valueField="dictValue" textField="dictText" editable="false"></td>
            </tr>
            <tr class="special_tr spare_parts_tr knife_tr">
                <td>订购原因</td><td colspan="5"><input class="easyui-textbox knife_td" id="extraOrderReason" name="extraOrderReason" style="width: 400px"></td>
            </tr>
            <tr hidden="hidden">
                <td colspan="5"><input class="easyui-textbox" id="orderInitialUserId" name="orderInitialUserId" style="width: 400px" value="<#if Session["userId"]?exists>${Session["userId"]}</#if>"></td>
            </tr>
        </table>

    </form>
</div>
<div id="dlgbutton">
    <a href="javascript:saveDlg()" class="easyui-linkbutton">保存</a>
    <a href="javascript:closeDlg()" class="easyui-linkbutton">关闭</a>
</div>

<div id="excelDlg" name="dlg" class="easyui-dialog" title="上传订单" style="width: 800px;height: 600px" closed="true" buttons="#excelDlgbutton">
    <form  method="post" enctype="multipart/form-data" id="excelForm" action="/wms/order/upload">
        <input type="file" name="file" id="file"/>
        <input type="submit" value="上传文件"/>
    </form>
</div>
<div id="excelDlgbutton">
    <a href="javascript:closeExcelDlg()" class="easyui-linkbutton">关闭</a>
</div>
</body>
</html>