<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>装配数据追溯</title>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/jquery.min.js"></script>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/locale/easyui-lang-zh_CN.js"></script>
    <link rel="stylesheet" href="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/themes/gray/easyui.css" type="text/css"/>
    <link rel="stylesheet" href="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/themes/icon.css" type="text/css"/>
    <link rel="stylesheet" href="${req.contextPath}/static/css/qcdata.css" type="text/css"/>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/datagrid-detailview.js"></script>
    <script type="text/javascript" src="${req.contextPath}/static/plugin/jquery-easyui-1.5.5.4/datagrid-filter.js"></script>
    <link  href="${req.contextPath}/static/layuiExtend/layui/css/layui.css" media="all" rel="stylesheet">
    <script src="${req.contextPath}/static/layuiExtend/layui/layui.js"></script>
</head>
<body>
    <div id="tab_single_table" title="VEI数据查询" style="padding:0px">
        <table id="dg2" class="easyui-datagrid" title="VEI数据查询" style="width:100%;height:100%"
               data-options="singleSelect:true,collapsible:true" toolbar="#tb2">
            <thead>
            <tr></tr>
            </thead>
        </table>
        <div id="tb2">
            <div>
                <!--线体名称：<input class="easyui-combobox" id="s_linename" name="s_linename" editable="false" size="15" value="" data-options="panelHeight:'auto',valueField:'ID',textField:'LineName',url:'qc?action=qc_getlinename',method:'post' "/>-->
                <!--设备名称：<input class="easyui-combobox" id="s_device_name" name="s_device_name" editable="false" size="15" data-options="valueField:'ID',textField:'Device_Name',method:'post' "/>-->
                <!--<span>起始时间：</span><input id="StartTime" class="easyui-datetimebox" editable="false" />&nbsp;-->
                <!--<span>结束时间：</span><input id="EndTime" class="easyui-datetimebox" editable="false" />-->
                <!--<a href="javascript:add_filters()" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加筛选</a>-->
                <a id="complexBtn" class="layui-btn"  >复杂查询</a>
                <!--<a href="javascript:search_record2()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>-->
                <a href="javascript:export_record2()" class="easyui-linkbutton" iconCls="icon-save" plain="true">导出</a>
            </div>
            <div id="msg2">查询条件：</div>
            <div id="result2" style="word-break:break-all;height:60px;width:500px;padding-left:50px;display: none;"></div>
        </div>
        <form id="excelfm2" name="excelfm2" method="post" action="qc?action=export_excel_more">
            <input type="hidden" id="f_devicename2" name="s_devicename"/>
            <input type="hidden" id="f_linename2" name="s_linename"/>
            <input type="hidden" id="f_condiction2" name="s_condiction"/>
        </form>
    </div>
</div>
<script type="text/javascript">
    //初始化全局变量
    var columns_auto_single=new Array(1);
    var complexDc;var dynamicCondition;
    //加载模型
    $(function(){
        $('#dg').datagrid({
            view: detailview,
            detailFormatter:function(index,row){
                return '<div style="padding:2px;position:relative;"><table class="ddv"></table></div>';
            },
            onExpandRow: function(index,row){
                var columns_auto=new Array(1);
                var s_egtypefl=$('#s_EgtypeFl').val();
                if(s_egtypefl==""){
                    alert("请输入流水号后再执行该操作")
                }else{
                    //查询数据表头
                    $.ajax({
                        url: 'qc?action=qc_tablecolumns&tablename='+row.Table_Name+'&db_flag='+row.DB_Flag,
                        cache: false,
                        type: 'POST',
                        data: "",
                        dataType: 'json',//返回类型
                        contentType: "application/json; charset=utf-8",//发送类型，重要，不然会报错
                        success: function (result) {
                            var arr = result.columns.split(',');
                            columns_auto[0] = function () {
                                var data = [];
                                for (var i = 0; i < arr.length-1; i++) {
                                    var str = {
                                        "field": "" + arr[i],
                                        "title": "" + arr[i],
                                        "width":100,
                                        "align": 'center'
                                    };
                                    data.push(str);
                                }
                                return data;
                            }();
                            //动态加载数据
                            var ddv = $('#dg').datagrid('getRowDetail',index).find('table.ddv');
                            ddv.datagrid({
                                url: 'qc?action=qc_tablerecord&tablename='+row.Table_Name+'&egtypefl='+s_egtypefl+'&fieldname='+row.Table_No+'&db_flag='+row.DB_Flag,
                                method: 'POST',
                                contentType: "application/json",
                                columns:columns_auto,//外层ajax请求的表头json
                                rownumbers: true,// 行号
                                autoRowHeight: false,
//                            pagination: true,// 分页条
//                            fit: true,// 自动使列适应表格宽度
//                            fitColumns: true,// 自动使列适应表格宽度
                                checkOnSelect: false,
                                selectOnCheck: true,
//                            pageSize: 5,
//                            pageList: [5, 10, 15, 20],
                                onResize:function(){
                                    $('#dg').datagrid('fixDetailRowHeight',index);
                                },
                                onLoadSuccess:function(){
                                    setTimeout(function(){
                                        $('#dg').datagrid('fixDetailRowHeight',index);
                                    },0);
                                }
                            });
                            $('#dg').datagrid('fixDetailRowHeight',index);
                        }
                    });
                }
            }
        });

        load_dynamic();
    });
    //多表汇总导出数据
    function export_record() {
//        $('#dg').datagrid('toExcel','dg.xls');    // export to excel
//        $('#dg').datagrid('print','DataGrid');    // print the datagrid
        $('#excelfm').form('load',{
            s_EgtypeFl:$('#s_EgtypeFl').val()
        });
        document.getElementById("excelfm").submit();
    }
    //单表查询导出数据
    function export_record2() {
//        $('#dg2').datagrid('toExcel','dg.xls');    // export to excel
        $('#excelfm2').form('load',{
            s_devicename:$('#s_device_name').combobox('getText'),
            s_linename:$('#s_linename').combobox('getText'),
            s_condiction:$("#result2")[0].innerHTML
        });
        document.getElementById("excelfm2").submit();
    }
    //查询记录-multi
    function search_record() {
        $('#dg').datagrid('load',{
            s_EgtypeFl:$('#s_EgtypeFl').val()
        });
    }
    //查询记录-single
    function search_record2() {
        $('#dg2').datagrid('load',{
            s_linename:$('#s_linename').combobox('getText'),
            s_devicename:$('#s_device_name').combobox('getText')
//            s_begintime:$('#StartTime').datetimebox('getValue'),
//            s_endtime:$('#EndTime').datetimebox('getValue')
        });
    }
    //动态加载数据
    function load_dynamic() {
        //查询数据表头
        $.ajax({
            url: '/mqms/voucher/columnNameAndComment?table=voucher',
            cache: false,
            type: 'POST',
            data: "",//json字符串
            dataType: 'json',//返回类型
            contentType: "application/json; charset=utf-8",//发送类型，重要，不然会报错
            success: function (result) {
                var arr = result;
                console.log(arr);
                //动态生成dcDemo中的li
                columns_auto_single[0] = function () {
                    var data = [];
                    var dataFields = [];
                    for (var i = 0; i < arr.length-1; i++) {
                        var str = {
                            "field": "" + arr[i].columnName,
                            "title": "" + arr[i].comment,
                            "width":150,
                            "align": 'center'
                        };
                        var str2= {
                            field: "" + arr[i].columnName,
                            title: "" + arr[i].comment,
                            edit:"text"
                        };
                        data.push(str);
                        dataFields.push(str2);
                    }
                    //高级查询
                    layui.config({
                        base: '${req.contextPath}/static/layuiExtend/layui_exts/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
                    }).extend({
                        dynamicCondition: 'dynamicCondition/dynamicCondition'
                    }).use(['table', 'form', 'dynamicCondition'], function () {
                        console.log("111");
                        var $ = layui.$, table = layui.table, form = layui.table;
                        dynamicCondition = layui.dynamicCondition;

                        //初始化查询实例
                        complexDc = dynamicCondition.create({
//                    elem: "#dcDemo" //通过容器选择器传入，也可以$("#dcDemo"),或者document.getElementById("dcDemo")
                            fields:dataFields
                            //,tableId:"listTable" //静态页面不好演示table数据表格更新
                            , type: "complex"  //type:"simple"/"complex"
                            , conditionTextId: "#msg2"
                            //当有多个动态条件查询实例时，定义instanceName属性可以通过dynamicCondition.getInstance(instanceName)获取对应的实例
                            , instanceName: "complexInstance"
                            , queryCallBack: function (requestData) {
                                $("#result2").html(JSON.stringify(requestData));
                                load_dynamic_records();
                            }
                        });
                        $("#result2").html(JSON.stringify(complexDc.buildRequestData()));
                        /**复杂查询*/
                        $("#complexBtn").on("click", function () {
                            dynamicCondition.getInstance("complexInstance").open();
                        });
                    });

                    return data;
                }();
                load_dynamic_records();
            }
        });
    }
    function load_dynamic_records() {
        var condiction=$("#result2")[0].innerHTML;
        //动态加载数据
        $("#dg2").datagrid({
            url: '/mqms/voucher/list',
            method: 'POST',
            toolbar:'#tb2',
            contentType: "application/json",
            columns:columns_auto_single,//外层ajax请求的表头json
            rownumbers: true,// 行号
            autoRowHeight: false,
            pagination: true,// 分页条
//                            fit: true,// 自动使列适应表格宽度
//                            fitColumns: true,// 自动使列适应表格宽度
            checkOnSelect: false,
            selectOnCheck: true,
            pageSize: 10,
            pageList: [10, 20, 40, 50]
        });
//        $("#dg2").datagrid("load");  //动态取数据
    }


    //正则验证
    $.extend($.fn.validatebox.defaults.rules, {
        checkInt: {
            validator: function (value) {
                var reg = /^[0-9][0-9]*$/;
                return reg.test(value);
            },
            message: '请输入有效整数值'
        },
        checkEgtypeFl: {
            validator: function (value) {
                var reg = /^[A-C]{1}[0-9]{2}\s[D-Z]{1}[0-9]{6}|[A-C]{1}[0-9]{3}[D-Z]{1}[0-9]{6}$/;
                return reg.test(value);
            },
            message: '请输入有效机型流水号C70 H888888|C706H888888'
        }
    });
//    //高级查询
//    layui.config({
//        base: '${req.contextPath}/static/layuiExtend/layui_exts/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
//    }).extend({
//        dynamicCondition: 'dynamicCondition/dynamicCondition'
//    }).use(['table', 'form', 'dynamicCondition'], function () {
//        console.log("111");
//        var $ = layui.$, table = layui.table, form = layui.table;
//        dynamicCondition = layui.dynamicCondition;
//    });
</script>
</body>
</html>